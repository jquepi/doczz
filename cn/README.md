# 从0开始设计对象存储

## 背景介绍

作者从11年开始接触存储，从最早的单机对象存储（基于文件系统分chunk，随机写转顺序写）到分布式对象存储（基于mysql+leveldb+openstack swift & mongodb + 类swift存储 & paxos+leveldb），有的存储包括基于存储的应用（备份、私有云盘），也有单纯的云存储服务。其实发现，基于场景去设计存储才更有意义。

## 需求

我目前期望实现一个低成本的单机存储用于存储私有数据，能够提供一定的扩展性，在此基础上扩展成分布式版本，它应该能够运行在配置较低（CPU、内存）的设备上，存储可能也是廉价的低擦写次数的，比如TLC的sd卡。

## 先从单机对象存储开始说起

近10多年来，开源基础设施大量涌现，使得实现一个简单的单机存储越来越容易。比如：leveldb/rocksdb、各种paxos/raft的实现。

### 我希望它该有的样子

- 尽可能快
- 支持加密和压缩
- 支持扩容
- **传输层透明（端到端）**
- 能够保障数据可用性

如果有这些功能，那就更好了：

- 秒传
- 多版本：包括快照和闪回（flashback）
- 识别对象类型：支持自定义插件
- 缩略图
- HEVC

### 反思以前过度设计的部分

断电一致性中关于一定保障数据完整的部分，也就是数据一旦写入，就需要保证数据可用性，以前的方案是实时刷盘，改进方案是几秒刷一次盘，客户端连接后，检查是否有需要重传的损坏的文件（服务启动时检查上次是否异常退出）即可。

### 存储层的设计原则

1. 元数据和数据分开存储
- 提供存储适配器，这样你可以随意修改成你想要的实现

2. 按文件大小分开存储（better to have）
- 小文件存储到`rocksdb`
- 大文件存储到独立文件

3. 只追加模式
- 适应WORM（写少读多）场景

4. 支持直接引用本地文件

5. 默认支持`snappy`

6. 文件级重复删除

7. 支持加密（数据私有安全）
- 拥有正确密钥的设备才能在设备端访问数据（全链路）
